(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{574:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"go程序是如何运行的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go程序是如何运行的"}},[t._v("#")]),t._v(" Go程序是如何运行的")]),t._v(" "),a("h3",{attrs:{id:"go程序的入口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go程序的入口"}},[t._v("#")]),t._v(" Go程序的入口？")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("main")]),t._v("方法？")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/4021/20220513221140.png",alt:"rukou"}})]),t._v(" "),a("p",[t._v("我这里是"),a("code",[t._v("mac m1")]),t._v("是"),a("code",[t._v("arm64")]),t._v("架构的，真正的入口是这几个文件")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("rt0")]),t._v("：runtime的入口")]),t._v(" "),a("li",[a("code",[t._v("linux")]),t._v("：哪个操作系统")]),t._v(" "),a("li",[a("code",[t._v("amd64/arm64")]),t._v("：什么架构的芯片")])]),t._v(" "),a("p",[t._v("如果是linux-amd64的，入口文件则为")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"textflag.h"')])]),t._v("\n\nTEXT "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_rt0_amd64_linux")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("NOSPLIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n\tJMP\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_rt0_amd64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nTEXT "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_rt0_amd64_linux_lib")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("NOSPLIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\tJMP\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_rt0_amd64_lib")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("都会进入"),a("code",[t._v("_rt0_amd64")]),t._v("这个方法去启动程序，这个是一个汇编语言。")]),t._v(" "),a("p",[a("span",{staticStyle:{color:"red","font-size":"32px"}},[t._v("所以go程序的入口是以"),a("code",[t._v("runtime/rt0_xxx.s")]),t._v("这样的文件为入口的")])]),t._v(" "),a("p",[t._v("接下来，执行"),a("code",[t._v("_rt0_amd64")]),t._v("方法，我们可以进行全局搜索：")]),t._v(" "),a("p",[t._v("找到"),a("code",[t._v("asm_amd64.s")]),t._v("文件里")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("TEXT "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("_rt0_amd64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("NOSPLIT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n\tMOVQ\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DI\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// argc")]),t._v("\n\tLEAQ\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SI\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// argv")]),t._v("\n\tJMP\truntime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rt0_go")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("这个方法就两行有意义的代码，就是将"),a("code",[t._v("argc")]),t._v("和"),a("code",[t._v("argv")]),t._v("放到寄存器里，就是一些命令行的参数;")]),t._v(" "),a("p",[t._v("下面就调用"),a("code",[t._v("runtime.rt0_go")]),t._v("方法，这个方法里有一个地方：")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("TEXT runtime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rt0_go")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("NOSPLIT"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("TOPFRAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// copy arguments forward on an even stack")]),t._v("\n\tMOVQ\tDI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AX\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// argc")]),t._v("\n\tMOVQ\tSI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BX\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// argv")]),t._v("\n\tSUBQ\t$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SP\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2args 2auto")]),t._v("\n\tANDQ\t$"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" SP\n\tMOVQ\tAX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tMOVQ\tBX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// create istack out of the given (operating system) stack.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// _cgo_init may update stackguard.")]),t._v("\n\tMOVQ\t$runtime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("g0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" DI\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LEAQ")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("104")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BX\n\tMOVQ\tBX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("g_stackguard0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tMOVQ\tBX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("g_stackguard1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tMOVQ\tBX"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("g_stack"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("stack_lo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tMOVQ\tSP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("g_stack"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("stack_hi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])]),a("p",[a("strong",[t._v("它会初始化"),a("code",[t._v("g0")]),t._v("协程的执行栈，go程序的第一个协程，它是为了调度协程而产生的协程。")])]),t._v(" "),a("h3",{attrs:{id:"运行时检测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运行时检测"}},[t._v("#")]),t._v(" 运行时检测")]),t._v(" "),a("p",[t._v("中间会有一堆的检查，直接跳过，我们走到")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("\tCLD\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// convention is D is always left cleared")]),t._v("\n\tCALL\truntime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("check")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("这里真正执行了go的一个方法，称呼为“运行时检测”：")]),t._v(" "),a("ul",[a("li",[t._v("检查各种类型的长度")]),t._v(" "),a("li",[t._v("检查指针操作")]),t._v(" "),a("li",[t._v("检查结构体字段的偏移量")]),t._v(" "),a("li",[t._v("检查"),a("code",[t._v("atomic")]),t._v("原子操作")]),t._v(" "),a("li",[t._v("检查"),a("code",[t._v("CAS")]),t._v("操作")]),t._v(" "),a("li",[t._v("检查栈大小是否是2的幂次")])]),t._v(" "),a("h3",{attrs:{id:"参数初始化runtime-args"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参数初始化runtime-args"}},[t._v("#")]),t._v(" 参数初始化"),a("code",[t._v("runtime.args")])]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("# 参数初始化\nCALL    runtime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nCALL   runtime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("osinit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("ul",[a("li",[t._v("对命令行中的参数进行处理")]),t._v(" "),a("li",[t._v("参数数量赋值给"),a("code",[t._v("argc int32")])]),t._v(" "),a("li",[t._v("参数值赋值给"),a("code",[t._v("argv **byte")])])]),t._v(" "),a("h3",{attrs:{id:"调度器初始化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调度器初始化"}},[t._v("#")]),t._v(" 调度器初始化")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("# 调度器初始化\nCALL   runtime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("schedinit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("ul",[a("li",[t._v("全局栈空间内存分配")]),t._v(" "),a("li",[t._v("加载命令行参数到"),a("code",[t._v("os.Args")])]),t._v(" "),a("li",[t._v("堆内存空间的初始化")]),t._v(" "),a("li",[t._v("加载操作系统环境变量")]),t._v(" "),a("li",[t._v("初始化当前系统线程")]),t._v(" "),a("li",[t._v("垃圾回收器的参数初始化")]),t._v(" "),a("li",[t._v("算法初始化(map、hash)")]),t._v(" "),a("li",[t._v("设置"),a("code",[t._v("process")]),t._v("数量，p结构体的数量")])]),t._v(" "),a("h3",{attrs:{id:"创建主协程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建主协程"}},[t._v("#")]),t._v(" 创建主协程")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// create a new goroutine to start program")]),t._v("\n\tMOVQ\t$runtime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mainPC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" AX\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// entry")]),t._v("\n\tPUSHQ\tAX\n\tPUSHQ\t$"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// arg size")]),t._v("\n\tCALL\truntime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("newproc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tPOPQ\tAX\n\tPOPQ\tAX\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[a("code",[t._v("mainPC")]),t._v("就是"),a("code",[t._v("runtime.main")]),t._v("方法的地址，调用了"),a("code",[t._v("newproc")]),t._v("就是"),a("code",[t._v("go")]),t._v("启动协程的关键字，也就是说来启动一个新协程，用来运行"),a("code",[t._v("runtime.manPC")]),t._v("方法，但是没有进行调度。")]),t._v(" "),a("p",[t._v("初始化一个"),a("code",[t._v("M")]),t._v("，用来调度主协程")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// start this M")]),t._v("\n\tCALL\truntime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mstart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\tCALL\truntime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("abort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mstart should never return")]),t._v("\n\tRET\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("接下来就是主协程来执行"),a("code",[t._v("runtime.main")]),t._v("函数")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mainPC is a function value for runtime.main, to be passed to newproc.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// The reference to runtime.main is made via ABIInternal, since the")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// actual function (not the ABI0 wrapper) is needed by newproc.")]),t._v("\nDATA\truntime·mainPC"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("$runtime·main"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("ABIInternal"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nGLOBL\truntime·"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mainPC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("RODATA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("会遇到一个比较重要的go代码")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//go:linkname main_main main.main")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main_main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[a("code",[t._v("go:linkname")]),t._v("：在编译的第二个阶段，链接器就会把它链接到 "),a("code",[t._v("main.main")]),t._v("就是我们用户自己写的"),a("code",[t._v("main")]),t._v("包下的"),a("code",[t._v("main")]),t._v("方法，这样用户的程序就跑起来了。")]),t._v(" "),a("p",[a("strong",[t._v("主协程执行主函数的操作内容")])]),t._v(" "),a("ul",[a("li",[t._v("执行runtime包的"),a("code",[t._v("init")]),t._v("方法")]),t._v(" "),a("li",[t._v("启动"),a("code",[t._v("gc")]),t._v("垃圾回收器")]),t._v(" "),a("li",[t._v("执行用户包依赖的"),a("code",[t._v("init")]),t._v("方法")]),t._v(" "),a("li",[t._v("执行用户主函数"),a("code",[t._v("main.main()")])])]),t._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),a("ul",[a("li",[t._v("Go启动时经历了检查、各种初始化、初始化协程调度的过程")]),t._v(" "),a("li",[a("code",[t._v("main.main()")]),t._v("也是在协程中运行的，还是在主协程中运行的，是第二个协程，第一个协程时"),a("code",[t._v("g0")])])]),t._v(" "),a("h2",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),a("ul",[a("li",[t._v("调度器是什么")]),t._v(" "),a("li",[t._v("为什么初始化M")]),t._v(" "),a("li",[t._v("为什么不是直接执行"),a("code",[t._v("main.main()")]),t._v("，而是将其放入调度器")])]),t._v(" "),a("h2",{attrs:{id:"体会"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#体会"}},[t._v("#")]),t._v(" 体会")]),t._v(" "),a("blockquote",[a("p",[t._v("Go程序启动过程像不像一个虚拟机，或者框架，围绕着用户的main方法去启动，加载一堆组件和初始化一堆内容。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);