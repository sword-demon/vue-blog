---
title: '会话'
date: 2022-06-01 22:39:15
# 永久链接
permalink: '/php/session'
sidebar: 'auto'
isShowComment: true
categories:
 - php
tags:
 - null
---



## 会话

>   会话就是一个进程组或多个进程组的集合；
>
>   1.   一个会话可以至少有一个控制终端、伪终端
>
>   2.   一个会话至少有一个前台进程组【前台：指能输入能执行命令的`bin/bash`】，其他的都是后台进程组
>   3.   一个会话如果连接了一个控制终端，就叫控制进程；因为这个会话首进程`bin/bash`是连接控制终端的【伪终端设备驱动程序 + TCP/IP 对端的SSH Client】，所以创建的子进程也会继承这个父进程的控制终端【0,1,2标准输入，标准输出，标准错误】；因为连接了终端，所以在终端的输入会影响前台进程组，如：`ctrl c`

```php
<?php


function showPID()
{
    $pid = posix_getpid();
    fprintf(STDOUT, "pid=%d, ppid=%d, gpid=%d, sid=%d\n",
        $pid, posix_getppid(), posix_getpgid($pid), posix_getsid($pid));
}


$pid = pcntl_fork();
showPID();

while (1) {
    sleep(1);
}
```



运行

```bash
[root@jb51 process]# php demo19.php 
pid=26214, ppid=24901, gpid=26214, sid=24901
pid=26215, ppid=26214, gpid=26214, sid=24901
```

>   这2个子进程会集成`bin/bash`父进程的一些属性，比如组ID，SID，以及文件描述符：0,1,2【控制终端】，`bin/bash`你可以叫他一个会话，一个会话首进程，一个控制进程。

```bash
cd /proc/26215
file exe
```

就可以看到是链接的`bin/bash`





可以使用如下命令来查看进程的情况

```bash
ps -exj
```

>   可以知道该进程的`PID`、`PPID`、`PGID`、`SID`以及这个进程是哪个`UID`用什么`COMMAND`在什么时间启动的，状态是`STAT[S,T,D,R]`，该进程还连接了哪个终端【你可以认为连接了哪个输入单元，可以简单的认为是你的显示器和键盘，但是是由内核的伪终端设备驱动程序虚拟出来的】

```bash
24901 26214 26214 24901 pts/2    26214 S+       0   0:00 php demo19.php XDG_SESSION_ID=163175 HOSTNAME=jb51.net TERM=xterm SHELL=/bin/bash HI
26214 26215 26214 24901 pts/2    26214 S+       0   0:00 php demo19.php XDG_SESSION_ID=163175 HOSTNAME=jb51.net TERM=xterm SHELL=/bin/bash HI
```

![流程](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/4021/20220601232113.png)



## 创建会话

:::tip 要求

1.   不能使用组长进程调用`setsid`函数，硬要调用就会报错
2.   我们先创建一个子进程，让父进程退出，由子进程调用`setsid`
3.   调用`setsid`之后，该进程会变成组长进程同时也会变成会话首进程
4.   同时该进程没有控制终端【可以认为它没有连接显示器，没有连接键盘】，你在终端输入任何数据都没有反应

:::



```php
<?php

function showPID()
{
    $pid = posix_getpid();
    fprintf(STDOUT, "pid=%d, ppid=%d, gpid=%d, sid=%d\n",
        $pid, posix_getppid(), posix_getpgid($pid), posix_getsid($pid));
}

// 创建一个子进程
$pid = pcntl_fork();

if ($pid > 0) {
    // 父进程退出
    exit(0);
}

// 调用这个函数后，该会话首进程会断开控制终端的连接
if (-1 == posix_setsid()) {
    echo "error" . PHP_EOL;
    $errno = pcntl_errno();
    echo pcntl_strerror($errno) . PHP_EOL;
} else {
    echo "创建会话首进程成功" . PHP_EOL;
}

showPID();

while (1) {
    sleep(1);
}
```

```bash
[root@jb51 process]# php demo20.php 
[root@jb51 process]# 创建会话首进程成功
pid=15069, ppid=1, gpid=15069, sid=15069
```

```bash
ps -exj

1 15069 15069 15069 ?           -1 Ss       0   0:00 php demo20.php XDG_SESSION_ID=165241 HOSTNAME=jb51.net TERM=xterm SHELL=/bin/bash HI
```

这里可以看到`?`这里是没有连接任何终端的，此时它的父进程变成了1号进程。

```bash
├─php,15069 demo20.php
```

此时它是运行在后台的进程，你在终端输入任何内容它都不会有任何反应。