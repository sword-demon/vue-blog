---
title: '优惠券模板业务思想'
date: 2022-01-13 21:20:15
# 永久链接
permalink: '/note/coupon_template'
sidebar: 'auto'
isShowComment: true
categories:
 - note
tags:
 - null
---



## 想实现功能

>   顾名思义 ，就是根据优惠券的模板去生成对应的优惠券，就是一个生产模具，模板也会携带大量的优惠券信息，比如：名称，有效期，优惠规则，面额等。模板本身也有创建人，状态等基本信息；当需要生成优惠券是，选择哪一个模板，在输入生成总数就可以了。

:::tip 字段重复值较多

优惠券和优惠券模板的重复字段比较多，为什么不直接跳过模板的环节？

1.   程序员都是懒人，主要是想逃过输入相同的模板信息，只需要输入一遍模板信息，就可以批量生产优惠券，提高效率
2.   创建优惠券模板和领取优惠券是两类人做的事情，两类服务是需要进行隔离。
3.   企业开发中，也是先有模板再有实现

:::



主要步骤：

1.   根据运营人员**设定的条件**构造**优惠券模板**

2.   条件：

     1.   名称
     2.   `logo`
     3.   分类
     4.   产品线
     5.   数量
     6.   规则

3.   模板规则即优惠券码规则：

     >   优惠券码一共有18位，有两个要求

     1.   不可以重复
     2.   有一定的识别性

     比如：

     :::tip

     -   前四位：产品线 + 类型
     -   中间六位：日期随机：220101
     -   后八位：`0~9`的随机数

     :::



:::warning 说明

规定优惠券必须有数量限制且优惠券(分发的)必须有优惠券码(优惠券的唯一识别性)

:::



## 使用技术方案

### 给优惠券模板生成”优惠券码“并保存到`redis(list)`中。

>   优惠券码是在一个服务实例中预先生成的，并放到`redis`中，这样做的目的有：

-   简单的解决优惠券码的一致性问题(`redis`的`Set`数据结构)
-   不会造成优惠券码的超发
-   不需要考虑分发优惠券时的配额问题



<p align="center"><img src="https://gitee.com/wxvirus/img/raw/master/img/20220113214123.png" alt="template_redis" /></p>



:::tip 并发问题

`Redis`是单线程操作，我们直接从队列里获取一个优惠券码，这个操作时原子的，而且每个请求都是排队的，当然就不用考虑并发问题了。

:::



### 清理过期的优惠券模板

**优惠券模板规定有使用期限，有两种过期策略：**

1.   `template`模板自己的定期清理策略(定时任务)
2.   使用`template`模块的其他模块自己校验(因为策略1存在延迟)



## 优惠券分发模块



### 根据用户id和优惠券状态查找用户优惠券记录

>   **（用户相关的）优惠券状态有3类：可用的、已使用的、过期的(未被使用的)**

>   用户查询的时候，首先应该判断是否存在过期的，但是没有被标记为过期的优惠券，如果存在，除了展示信息以外，还要进行额外的过期处理。

1.   用户通过优惠券状态从分发模块查询优惠券
2.   分发模块从`redis`中检索(缓存穿透和雪崩)
3.   过期优惠券的处理发送到`kafka`进行延迟过期处理策略，进行修改对应状态标识，回写`MySQL`



:::tip 耗时操作

1.   从数据库检索数据，所以我们使用`redis`缓存来处理
2.   过期优惠券需要回写`MySQL`，所以我们需要将数据发送给`kafka`然后进行数据库交互

:::



### 根据用户id查找当前可以领取的优惠券模板

>   1.   优惠券模板从`template`模块处获取(熔断兜底策略，保证模块不挂掉)
>   2.   根据优惠券的领取限制，比对当前用户所拥有的优惠券，做出判断

<p align="center"><img src="https://gitee.com/wxvirus/img/raw/master/img/20220113220259.png" alt="celue" /></p>



### 用户领取优惠券

>   1.   优惠券模板从`template`模块处获取(熔断兜底策略，保证模块不挂掉)
>   2.   根据优惠券的领取限制，比对当前用户所拥有的优惠券，做出判断是否可以领取
>   3.   从`redis`中获取优惠券码
>   4.   优惠券写入`MySQL`和`Redis`中

<p align="center"><img src="https://gitee.com/wxvirus/img/raw/master/img/20220113220446.png" alt="get_coupon" /></p>



### 结算(核销)优惠券

>1.   校验需要结算的优惠券是否是”合法的(属于当前用户 && 可用的)“
>2.   使用结算微服务(settlement)计算结算数据
>3.   如果是核销，需要写回`MySQL`

<p align="center"><strong>从redis中检索得到用户当前的优惠券</strong><img src="https://gitee.com/wxvirus/img/raw/master/img/20220113220916.png" alt="从redis中检索得到用户当前的优惠券" /></p>



### 根据优惠券类型结算优惠券

1.   优惠券是分类的(满减类、折扣类、立减类、组合类)，不同累的优惠券有不同的计算方法
2.   不同类的优惠券可以组合，所以，也需要有不同的计算方法



<p align="center"><img src="https://gitee.com/wxvirus/img/raw/master/img/20220113222203.png" alt="结算优惠券" /></p>



## 存储设计

优惠券模板表：`coupon_template`

```sql
drop table if exists `coupon_template`;
CREATE TABLE `coupon_template`
(
    `id`           int(11) unsigned NOT NULL AUTO_INCREMENT,
    `available`    tinyint(1)       NOT NULL DEFAULT '0' comment '是否可用',
    `expired`      tinyint(1)       NOT NULL DEFAULT '0' comment '表示模板是否过期',
    `name`         varchar(64)      NOT NULL,
    `logo`         varchar(255)     NOT NULL,
    `intro`        varchar(255)     NOT NULL,
    `category`     varchar(64)      NOT NULL,
    `product_line` int(11)          NOT NULL DEFAULT '0' comment '产品线',
    `coupon_count` int(11)          NOT NULL DEFAULT '0',
    `create_time`  datetime         NOT NULL,
    `user_id`      bigint(20)       NOT NULL DEFAULT '0' comment '创建者',
    `template_key` varchar(128)     NOT NULL comment '优惠券模板标识',
    `target`       int(11)          NOT NULL DEFAULT '0' comment '用途',
    `rule`         varchar(1024)     NOT NULL comment '规则 比如领取限制 个数限制 过期时间限制 存储为json',
    PRIMARY KEY (`id`),
    UNIQUE KEY `coupon_name` (`name`) USING BTREE,
    KEY `category` (`category`),
    KEY `user_id` (`user_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4 comment = '优惠券模板表';
```

`name`是唯一键

`category`和`user_id`建立了单列索引，都是为了方便去检索。



(用户)优惠券表：`coupon`

记录用户所属的优惠券信息

```sql
drop table if exists `coupon`;
create table coupon (
    id int(11) unsigned not null auto_increment,
    template_id int(11) not null default 0 comment '对应模板表的逻辑外键',
    user_id bigint(20) not null default 0 comment '所属用户的id',
    coupon_code varchar(64) not null comment '优惠券码',
    assign_time datetime not null default '0000-01-01 00:00:00' comment '领取时间',
    status int(11) not null default 0 comment '状态 可使用 已使用 过期的',
    primary key (`id`),
    key `template_id` (`template_id`),
    key `user_id` (`user_id`)
)engine = InnoDB DEFAULT CHARSET=utf8mb4 comment='用户优惠券表';
```



## 缓存设计

### 优惠券码缓存

1.   优惠券系统使用`redis`做缓存，所以，都是`KV`类型
2.   `Key`需要有意义，且不能与原有的`Key`冲突
3.   优惠券码需要永久存在，不设定过期时间



:::tip KV设计

`Key` = 前缀(wxvirus_coupon_template_code_) + 后缀(优惠券模板数据表主键)

`Value`类型：`list`

:::



### 用户优惠券缓存

1.   用户优惠券根据状态分为(未使用、已使用、已过期)三类
2.   用户数据保存在`MySQL`中，且数据量大，不适合长时间驻留在`redis`中，需要设置过期时间



:::tip KV设计

`Key` = 前缀(`wxvirus_user_coupon_usable_`、`wxvirus_user_coupon_used_`、`wxvirus_user_coupon_expired_`) + 后缀(优惠券模板数据表主键)

`Value`类型：`hash(key: 优惠券id； value: 优惠券信息)`

:::





## 功能微服务

-   面向运营的优惠券模板创建服务(template_module)
-   面向用户的优惠券分发服务(distribution_module)
-   结算服务(settlement_module)

<p align="center"><img src="https://gitee.com/wxvirus/img/raw/master/img/20220113225624.png" alt="功能微服务设计" /></p>





